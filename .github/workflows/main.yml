name: Move Data from Account_Raw to Omega

on:
  schedule:
    - cron: "*/2 * * * *"   # every 2 minutes
  workflow_dispatch:        # allow manual runs too

jobs:
  move-data:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install basic packages
        run: |
          sudo apt-get update -y
          sudo apt-get install -y wget bzip2 ca-certificates

      - name: Download & install SnowSQL (versioned installer, local install)
        id: install_snowsql
        run: |
          set -e
          mkdir -p snowsql_install
          # Version to install (change if you want a different version)
          SNOWSQL_VERSION="1.2.31"
          SNOWSQL_BASH="snowsql-${SNOWSQL_VERSION}-linux_x86_64.bash"
          # AWS repo path (stable)
          SNOWSQL_URL="https://sfc-repo.snowflakecomputing.com/snowsql/bootstrap/1.2/linux_x86_64/${SNOWSQL_BASH}"
          echo "Downloading ${SNOWSQL_URL}"
          wget -q -O "$SNOWSQL_BASH" "$SNOWSQL_URL"

          # Ensure the installer is executable
          chmod +x "$SNOWSQL_BASH"

          # Install into a local, writable directory (avoid modifying /bin or system files)
          export SNOWSQL_DOWNLOAD_DIR="$(pwd)/snowsql_install"
          echo "Installing to $SNOWSQL_DOWNLOAD_DIR"
          # Run installer in batch mode so it won't prompt; installer will put files into SNOWSQL_DOWNLOAD_DIR
          ./"$SNOWSQL_BASH" -b

          # Check installed binary
          echo "Installed files:"
          ls -la snowsql_install
          ./snowsql_install/snowsql -v || true

      - name: Show SQL file (debug)
        run: |
          echo "Listing repo files:"
          ls -la
          echo "First 200 lines of SQL file:"
          sed -n '1,200p' sql/move_data.sql || true

      - name: Run SQL file with snowsql
        env:
          SNOW_ACCOUNT: ${{ secrets.SNOW_ACCOUNT }}
          SNOW_USER: ${{ secrets.SNOW_USER }}
          SNOW_PWD: ${{ secrets.SNOW_PWD }}
          SNOW_WAREHOUSE: ${{ secrets.SNOW_WAREHOUSE }}
          SNOW_DATABASE: ${{ secrets.SNOW_DATABASE }}
          SNOW_SCHEMA: ${{ secrets.SNOW_SCHEMA }}
          SQL_FILE: "sql/move_data.sql"
        run: |
          set -e
          echo "Executing SQL file via snowsql..."
          # execute the SQL file using the just-installed snowsql
          ./snowsql_install/snowsql -a "$SNOW_ACCOUNT" -u "$SNOW_USER" -p "$SNOW_PWD" \
            -w "$SNOW_WAREHOUSE" -d "$SNOW_DATABASE" -s "$SNOW_SCHEMA" \
            -f "$SQL_FILE"
