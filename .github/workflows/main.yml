name: Move Data from Account_Raw to Omega

on:
  schedule:
    - cron: "*/2 * * * *"   # every 2 minutes
  workflow_dispatch:

jobs:
  run-sql:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install node deps
        run: npm install jsonwebtoken node-fetch@2

      - name: Decode private key
        run: |
          echo "${{ secrets.SNOW_PRIVATE_KEY_BASE64 }}" | base64 --decode > ./rsa_key.p8
          chmod 600 ./rsa_key.p8

      - name: Read SQL file (Move_data)
        run: |
          SQL_CONTENT="$(tr '\n' ' ' < sql/Move_data.sql)"
          echo "$SQL_CONTENT" > sql_encoded.txt

      - name: Generate JWT and call Snowflake SQL API
        env:
          SNOW_ACCOUNT: ${{ secrets.SNOW_ACCOUNT }}
          SNOW_USER: ${{ secrets.SNOW_USER }}
          SNOW_DATABASE: ${{ secrets.SNOW_DATABASE }}
          SNOW_SCHEMA: ${{ secrets.SNOW_SCHEMA }}
          SNOW_WAREHOUSE: ${{ secrets.SNOW_WAREHOUSE }}
        run: |
          node <<'EOF'
          const fs = require('fs');
          const jwt = require('jsonwebtoken');
          const fetch = require('node-fetch');

          const account = process.env.SNOW_ACCOUNT;
          const user = process.env.SNOW_USER;
          const now = Math.floor(Date.now() / 1000);
          const payload = {
            iss: account,
            sub: user,
            iat: now,
            exp: now + 60,
            aud: `https://${account}.snowflakecomputing.com`
          };

          const key = fs.readFileSync('./rsa_key.p8', 'utf8');
          const token = jwt.sign(payload, key, { algorithm: 'RS256' });

          const sql = fs.readFileSync('sql_encoded.txt', 'utf8');
          const url = `https://${account}.snowflakecomputing.com/api/v2/statements/`;
          const body = {
            statement: sql,
            database: process.env.SNOW_DATABASE,
            schema: process.env.SNOW_SCHEMA,
            warehouse: process.env.SNOW_WAREHOUSE,
            timeout: 0
          };

          (async () => {
            console.log('Submitting SQL...');
            const r = await fetch(url, {
              method: 'POST',
              headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
              body: JSON.stringify(body)
            });
            const j = await r.json();
            console.log('POST status', r.status);
            console.log(JSON.stringify(j, null, 2));

            if (!j.id) {
              console.error('No id returned');
              process.exit(2);
            }

            const id = j.id;
            const statusUrl = url + id;
            for (let i = 0; i < 30; i++) {
              await new Promise(r => setTimeout(r, 1000));
              const s = await fetch(statusUrl, { headers: { 'Authorization': 'Bearer ' + token } });
              const sj = await s.json();
              console.log('Poll', i, 'status', s.status);
              console.log(JSON.stringify(sj, null, 2));

              if (sj.status && (sj.status.state === 'SUCCESS' || sj.status.state === 'FAILED')) {
                if (sj.status.state === 'SUCCESS') {
                  console.log('SUCCESS');
                  process.exit(0);
                } else {
                  console.error('FAILED');
                  process.exit(3);
                }
              }
            }

            console.error('Timeout waiting for statement');
            process.exit(4);
          })();
          EOF
