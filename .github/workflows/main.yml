name: Move Data from Account_Raw to Omega

on:
  workflow_dispatch:

jobs:
  move_data:
    runs-on: ubuntu-latest

    env:
      SNOW_ACCOUNT: your_account_name   # e.g. abcd-xy12345
      SNOW_USER: your_snowflake_user
      SNOW_DATABASE: SNOW_GIT_DB
      SNOW_SCHEMA: SNOW_GIT_SCHEMA
      SNOW_WAREHOUSE: COMPUTE_WH
      SNOWFLAKE_PUBKEY_FP: your_public_key_fingerprint

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ§© Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: ğŸ” Check SQL file
        run: |
          echo "ğŸ“‚ Checking SQL file..."
          if [ ! -f move_data.sql ]; then
            echo "âŒ move_data.sql not found!"
            exit 1
          fi
          echo "âœ… SQL prepared. Preview (first 200 chars):"
          head -c 200 move_data.sql

      - name: ğŸš€ Run SQL in Snowflake
        run: |
          node <<'EOF'
          const fs = require('fs');
          const jwt = require('jsonwebtoken');
          const fetch = require('node-fetch');

          const account = process.env.SNOW_ACCOUNT;
          const user = process.env.SNOW_USER;
          const fingerprint = process.env.SNOWFLAKE_PUBKEY_FP;
          const database = process.env.SNOW_DATABASE;
          const schema = process.env.SNOW_SCHEMA;
          const warehouse = process.env.SNOW_WAREHOUSE;

          if (!account || !user || !fingerprint) {
            console.error("âŒ Missing required environment variables.");
            process.exit(1);
          }

          const key = fs.readFileSync('./rsa_key.p8', 'utf8');
          const now = Math.floor(Date.now() / 1000);

          const payload = {
            iss: `${account}.${user}.${fingerprint}`,
            sub: `${account}.${user}`,
            iat: now,
            exp: now + 60,
            aud: `https://${account}.snowflakecomputing.com`
          };

          const token = jwt.sign(payload, key, { algorithm: 'RS256' });

          const sql = fs.readFileSync('move_data.sql', 'utf8').trim();
          if (!sql) {
            console.error("âŒ SQL file is empty!");
            process.exit(2);
          }

          const url = `https://${account}.snowflakecomputing.com/api/v2/statements`;
          const body = {
            statement: sql,
            database,
            schema,
            warehouse
          };

          (async () => {
            console.log("ğŸš€ Submitting SQL to Snowflake...");
            const res = await fetch(url, {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(body)
            });

            const data = await res.json();
            console.log("Response status:", res.status);
            console.log(JSON.stringify(data, null, 2));

            if (!data.statementHandle) {
              console.error("âŒ No statement handle returned!");
              process.exit(3);
            }

            console.log("âœ… SQL executed successfully!");
            console.log(`ğŸ“Š Rows inserted: ${data.stats?.numRowsInserted || 0}, updated: ${data.stats?.numRowsUpdated || 0}`);
          })();
          EOF
