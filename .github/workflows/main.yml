name: Move Data from Account_Raw to Omega

on:
  schedule:
    - cron: "*/2 * * * *"   # every 2 minutes
  workflow_dispatch:        # allow manual runs too

jobs:
  move-data:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install basic packages
        run: |
          sudo apt-get update -y
          sudo apt-get install -y wget bzip2 ca-certificates

           - name: Download & install SnowSQL (verbose + capture logs)
        id: install_snowsql
        run: |
          set -euo pipefail
          mkdir -p snowsql_install
          SNOWSQL_VERSION="1.2.31"
          SNOWSQL_BASH="snowsql-${SNOWSQL_VERSION}-linux_x86_64.bash"
          SNOWSQL_URL="https://sfc-repo.snowflakecomputing.com/snowsql/bootstrap/1.2/linux_x86_64/${SNOWSQL_BASH}"

          echo "Downloading ${SNOWSQL_URL}"
          wget -q -O "$SNOWSQL_BASH" "$SNOWSQL_URL" || { echo "wget failed (exit $?)"; exit 2; }

          chmod +x "$SNOWSQL_BASH" || { echo "chmod failed"; exit 3; }

          # Installer verbose log file
          INSTALL_LOG="$(pwd)/snowsql_install/install.log"
          echo "Installer log -> $INSTALL_LOG"
          echo "Installer environment:"
          uname -a
          lsb_release -a || true
          env | sort

          # Run the installer in verbose mode and capture both stdout and stderr
          # The -b switch does a batch install; -v for verbose if supported.
          # Redirect stdout+stderr to log file so we can inspect
          echo "Running installer..."
          # run the installer, allow installer to write into current directory (snowsql_install)
          # use SNOWSQL_DOWNLOAD_DIR to prefer local installation
          export SNOWSQL_DOWNLOAD_DIR="$(pwd)/snowsql_install"
          echo "SNOWSQL_DOWNLOAD_DIR=$SNOWSQL_DOWNLOAD_DIR" >> "$INSTALL_LOG"
          # run installer and capture full output
          ( set -x; ./"$SNOWSQL_BASH" -b -v ) > >(tee -a "$INSTALL_LOG") 2> >(tee -a "$INSTALL_LOG" >&2) || {
            echo "Installer exited with code $? - see $INSTALL_LOG for details"
            echo "==== INSTALL LOG START ===="
            sed -n '1,400p' "$INSTALL_LOG" || true
            echo "==== INSTALL LOG END ===="
            exit 4
          }

          echo "Installer finished. Showing installed files:"
          ls -la snowsql_install || true
          echo "Show snowsql version (if present):"
          if [ -x ./snowsql_install/snowsql ]; then
            ./snowsql_install/snowsql -v || true
          else
            echo "snowsql binary not found in snowsql_install"
            echo "Install dir listing:"
            ls -la snowsql_install || true
            exit 5
          fi


      - name: Show SQL file (debug)
        run: |
          echo "Listing repo files:"
          ls -la
          echo "First 200 lines of SQL file:"
          sed -n '1,200p' sql/move_data.sql || true

      - name: Run SQL file with snowsql
        env:
          SNOW_ACCOUNT: ${{ secrets.SNOW_ACCOUNT }}
          SNOW_USER: ${{ secrets.SNOW_USER }}
          SNOW_PWD: ${{ secrets.SNOW_PWD }}
          SNOW_WAREHOUSE: ${{ secrets.SNOW_WAREHOUSE }}
          SNOW_DATABASE: ${{ secrets.SNOW_DATABASE }}
          SNOW_SCHEMA: ${{ secrets.SNOW_SCHEMA }}
          SQL_FILE: "sql/move_data.sql"
        run: |
          set -e
          echo "Executing SQL file via snowsql..."
          # execute the SQL file using the just-installed snowsql
          ./snowsql_install/snowsql -a "$SNOW_ACCOUNT" -u "$SNOW_USER" -p "$SNOW_PWD" \
            -w "$SNOW_WAREHOUSE" -d "$SNOW_DATABASE" -s "$SNOW_SCHEMA" \
            -f "$SQL_FILE"
