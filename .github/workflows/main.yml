name: Move Data from Account_Raw to Omega

on:
  schedule:
    - cron: "*/2 * * * *"   # every 2 minutes
  workflow_dispatch:

jobs:
  run-sql:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install node deps
        run: npm install jsonwebtoken node-fetch@2

      - name: Decode private key
        run: |
          echo "${{ secrets.SNOW_PRIVATE_KEY_BASE64 }}" | base64 --decode > ./rsa_key.p8
          chmod 600 ./rsa_key.p8

      - name: Prepare SQL file and verify contents
        run: |
          echo "üìÇ Checking SQL file..."
          if [ ! -f "sql/move_data.sql" ]; then
            echo "‚ùå File not found!"
            exit 2
          fi

          # Remove comments (--) and empty lines, flatten to single line
          grep -vE '^\s*--|^\s*$' sql/move_data.sql | tr '\n' ' ' > sql_encoded.txt

          echo "‚úÖ SQL prepared. Preview (first 200 chars):"
          head -c 200 sql_encoded.txt

      - name: Generate JWT and call Snowflake SQL API
        env:
          SNOW_ACCOUNT: ${{ secrets.SNOW_ACCOUNT }}
          SNOW_USER: ${{ secrets.SNOW_USER }}
          SNOW_DATABASE: ${{ secrets.SNOW_DATABASE }}
          SNOW_SCHEMA: ${{ secrets.SNOW_SCHEMA }}
          SNOW_WAREHOUSE: ${{ secrets.SNOW_WAREHOUSE }}
          SNOWFLAKE_PUBKEY_FP: ${{ secrets.SNOWFLAKE_PUBKEY_FP }}
        run: |
          node <<'EOF'
          const fs = require('fs');
          const jwt = require('jsonwebtoken');
          const fetch = require('node-fetch');

          const account = process.env.SNOW_ACCOUNT;
          const user = process.env.SNOW_USER;
          const fingerprint = process.env.SNOWFLAKE_PUBKEY_FP;

          if (!account || !user || !fingerprint) {
            console.error("‚ùå Missing required environment variables.");
            process.exit(1);
          }

          const key = fs.readFileSync('./rsa_key.p8', 'utf8');
          const now = Math.floor(Date.now() / 1000);

          const payload = {
            iss: `${account}.${user}.${fingerprint}`,
            sub: `${account}.${user}`,
            iat: now,
            exp: now + 60,
            aud: `https://${account}.snowflakecomputing.com`
          };

          const token = jwt.sign(payload, key, { algorithm: 'RS256' });

          const sql = fs.readFileSync('sql_encoded.txt', 'utf8').trim();
          if (!sql) {
            console.error("‚ùå SQL file is empty!");
            process.exit(2);
          }

          const url = `https://${account}.snowflakecomputing.com/api/v2/statements`;
          const body = {
            statement: sql,
            database: process.env.SNOW_DATABASE,
            schema: process.env.SNOW_SCHEMA,
            warehouse: process.env.SNOW_WAREHOUSE
          };

          (async () => {
            console.log("üöÄ Submitting SQL to Snowflake...");
            const res = await fetch(url, {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(body)
            });

            const data = await res.json();
            console.log("Response status:", res.status);
            console.log(JSON.stringify(data, null, 2));

            if (!data.id) {
              console.error("‚ùå No statement ID returned!");
              process.exit(3);
            }

            console.log("‚úÖ SQL executed successfully!");
          })();
          EOF
